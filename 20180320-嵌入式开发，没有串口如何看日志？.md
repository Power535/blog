
本文主要探讨嵌入式开发中消息日志输出的方式，全文1200字，读完大约需要3分钟。首发于微信公众号“rocky-says”，欢迎转载。

最近客户的一个项目，试产阶段发现有部分盒子没有正常启动。项目出于第三方的安全要求，板子上没有串口，准确说是PCB设计阶段没有给串口布线。以前说没有串口，基本上硬件上都预留了串口位，只是没有贴上串口座子而已，这种情况下焊上座子就好了~但现在没有串口，是真没有。

产品无法正常启动，但又拿不到打印信息，到底是什么问题，盲了，所以解决问题基本靠猜。会议上项目，产品，管理，硬件，软件，技术支持，大家纷纷脑洞大开，头脑风暴找原因，可能的情形好几种，但都比较难落实和验证。
后来我想起了以前实现过在bootloader支持framebuffer的方式，把系统启动的日志消息通过HDMI输出到电视上，最终发现是系统分区数据被破坏，加载前的完整性验证没有通过。

> 关于bootloader支持framebufer请参考我以前的两篇文章:
> 1. [博通机顶盒平台framebuffer输出（一）](https://blog.csdn.net/guyongqiangx/article/details/53204512)
> 2. [博通机顶盒平台framebuffer输出（二）](https://blog.csdn.net/guyongqiangx/article/details/53204539)
> 
> 另外也可以参考u-boot支持framebuffer的驱动。

通常串口打印输出是嵌入式开发中最常见最基础的一种，其实除了串口外，也还有其他可能的办法，以防在串口不工作时使用，例如上面的framebuffer方式就是其中一种。

以下是我所想到的可能的途径：

1. 串口

最直接最常见的方式。

串口输出的最大优点是设备驱动非常简单，对于有串口模块(如NS16550)的芯片，通过寄存器设置好串口引脚和波特率就可以使用了。

对于系统复位早期，只需要在汇编或者C代码中初始化完串口就可以跟踪了，可以看到较早时期的信息。

2. 内存

还有一种比串口更简洁的方式是将日志消息保存到指定的内存区域，然后通过一些外部工具查看或导出内存区域的信息来了解详细的情况。
 
3. 文件

系统启动后，将日志消息以文件的形式保存到文件系统，通过其他办法读取文件来获取调试信息。例如，将消息日志保存到U盘上，这样可以离线在电脑上读取U盘上保存的信息。

当然，也不一定需要文件系统，例如可以将日志消息以原始的方式写到flash上，通过烧录器或其它方式下载flash上的日志数据也是可以的。这种方式跟存放到内存有一些相似。

4. 显示

这里也就前面我所采用的办法，没有串口的情况下，实现显示驱动，然后将日志消息发送到framebuffer通过显示输出。相对前面的几种方式，显示输出略微复杂，主要是需要有显示接口，也需要在bootloader实现显示驱动。

5. 网络转发

在有网口的情况下，也可以考虑在网络初始化完成后通过网口将日志消息发送出来。可以参考类似广播消息的方式，或者类似刷机的fastboot方式那样，将设备初始化为一个服务端，然后通过客户端建立连接，实现基于网络的控制台，基于控制台就可以进行各种操作了。

6. 其它方式

实际上基于上面网络转发的方式，理论上任何数据输出接口都可以用来传输消息。例如，通过I2C总线转串口，通过USB转串口；又或者使用wifi或蓝牙建立连接等等，都可以达到将日志消息输出的目的。

以上6中方式中，将日志输出到串口或保存到内存最简单，需要的额外工作最少。串口输出比较直观，保存到内存需要有可以查看内存的工具。也可以采用多种方式结合，例如先将日志保存到内存，等系统外围设备初始化完成后再将其从内存转移到U盘或通过外部设备。

除了上面提到的种种方式外，使用JTAG调试是最根本最直接的了，只不过在量产的板子上很多都没有预留JTAG接口，又或者没有JTAG调试设备，无法使用这种方式。